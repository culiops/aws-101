#!/bin/sh

## Just for test ASG request to
ec2_private_ip=$(curl http://169.254.169.254/latest/meta-data/local-ipv4)
echo $ec2_private_ip > /opt/test.html 


## Install and start service
sudo amazon-linux-extras install docker
sudo systemctl start docker
sudo systemctl enable docker
sudo usermod -a -G docker ec2-user
sudo curl -L https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m) -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

## Copy docker-compose.yml content by encode base64 to instance
echo "dmVyc2lvbjogJzMuMScKCnNlcnZpY2VzOgogIGdhdGV3YXk6CiAgICBpbWFnZTogbmdpbnhwcm94eS9uZ2lueC1wcm94eQogICAgY29udGFpbmVyX25hbWU6IGdhdGV3YXkKICAgIHZvbHVtZXM6CiAgICAgIC0gY29uZjovZXRjL25naW54L2NvbmYuZAogICAgICAtIGh0bWw6L3Vzci9zaGFyZS9uZ2lueC9odG1sCiAgICAgIC0gdmhvc3Q6L2V0Yy9uZ2lueC92aG9zdC5kCiAgICAgIC0gY2VydHM6L2V0Yy9uZ2lueC9jZXJ0cwogICAgICAtIC92YXIvcnVuL2RvY2tlci5zb2NrOi90bXAvZG9ja2VyLnNvY2s6cm8KICAgIHBvcnRzOgogICAgICAtICI4MDo4MCIKICAgICAgLSAiNDQzOjQ0MyIKICAgIGRlcGxveToKICAgICAgcmVzb3VyY2VzOgogICAgICAgIGxpbWl0czoKICAgICAgICAgIGNwdXM6IDAuNTAKICAgICAgICAgIG1lbW9yeTogMjU2TQogICAgcmVzdGFydDogImFsd2F5cyIKICAgIGRlcGVuZHNfb246CiAgICAgIGFwcDoKICAgICAgICBjb25kaXRpb246IHNlcnZpY2VfaGVhbHRoeQoKICBhY21lOgogICAgaW1hZ2U6IG5naW54cHJveHkvYWNtZS1jb21wYW5pb246bGF0ZXN0CiAgICBjb250YWluZXJfbmFtZTogYWNtZQogICAgdm9sdW1lc19mcm9tOgogICAgICAtIGdhdGV3YXkKICAgIHZvbHVtZXM6CiAgICAgIC0gYWNtZTovZXRjL2FjbWUuc2gKICAgICAgLSBjZXJ0czovZXRjL25naW54L2NlcnRzOnJ3CiAgICAgIC0gL3Zhci9ydW4vZG9ja2VyLnNvY2s6L3Zhci9ydW4vZG9ja2VyLnNvY2s6cm8KICAgIGVudmlyb25tZW50OgogICAgICBOR0lOWF9QUk9YWV9DT05UQUlORVI6IGdhdGV3YXkKICAgICAgREVGQVVMVF9FTUFJTDogYWRtaW5AY3VsaW9wcy5kZXYKICAgIGRlcGxveToKICAgICAgcmVzb3VyY2VzOgogICAgICAgIGxpbWl0czoKICAgICAgICAgIGNwdXM6IDAuMjUKICAgICAgICAgIG1lbW9yeTogMTI4TQogICAgcmVzdGFydDogImFsd2F5cyIKICAgIGRlcGVuZHNfb246CiAgICAgIC0gImdhdGV3YXkiCgogIGFwcDoKICAgIGltYWdlOiB3b3JkcHJlc3MKICAgIHJlc3RhcnQ6IGFsd2F5cwogICAgZW52aXJvbm1lbnQ6CiAgICAgIFdPUkRQUkVTU19EQl9IT1NUOiBkYgogICAgICBXT1JEUFJFU1NfREJfVVNFUjogY3VsaW9wX2Jsb2cKICAgICAgV09SRFBSRVNTX0RCX1BBU1NXT1JEOiBjdWxpb3BfYmxvZwogICAgICBXT1JEUFJFU1NfREJfTkFNRTogY3VsaW9wX2Jsb2cKICAgICAgVklSVFVBTF9IT1NUOiBibG9nLmN1bGlvcHMuY2xvdWQKICAgICAgTEVUU0VOQ1JZUFRfSE9TVDogYmxvZy5jdWxpb3BzLmNsb3VkCiAgICBoZWFsdGhjaGVjazoKICAgICAgdGVzdDogWyJDTUQiLCAiY3VybCIsICItZiIsICJodHRwOi8vbG9jYWxob3N0LyJdCiAgICAgIGludGVydmFsOiAzMHMKICAgICAgdGltZW91dDogMTBzCiAgICAgIHJldHJpZXM6IDUKICAgIHZvbHVtZXM6CiAgICAgIC0gd29yZHByZXNzOi92YXIvd3d3L2h0bWwKICAgICAgLSAvb3B0L3Rlc3QuaHRtbDovdmFyL3d3dy9odG1sL3Rlc3QuaHRtbAoKICBkYjoKICAgIGltYWdlOiBteXNxbDo4LjAKICAgIHJlc3RhcnQ6IGFsd2F5cwogICAgZW52aXJvbm1lbnQ6CiAgICAgIE1ZU1FMX0RBVEFCQVNFOiBjdWxpb3BfYmxvZwogICAgICBNWVNRTF9VU0VSOiBjdWxpb3BfYmxvZwogICAgICBNWVNRTF9QQVNTV09SRDogY3VsaW9wX2Jsb2cKICAgICAgTVlTUUxfUkFORE9NX1JPT1RfUEFTU1dPUkQ6ICcxJwogICAgdm9sdW1lczoKICAgICAgLSBkYjovdmFyL2xpYi9teXNxbAoKdm9sdW1lczoKICB3b3JkcHJlc3M6CiAgZGI6CiAgY29uZjoKICB2aG9zdDoKICBjZXJ0czoKICBodG1sOgogIGFjbWU6" | base64 --decode > /root/docker-compose.yml

## Start application
docker-compose -f /root/docker-compose.yml up -d
